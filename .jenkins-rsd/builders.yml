# small bash-scripts that will be invoked one after the other in the jobs
- builder:
    name: heme-remove-build
    builders:
        - shell: |
            cd $WORKSPACE
            rm -rf build RegressionTests
            mkdir build

- builder:
    name: heme-configure
    builders:
        - shell: |
            case $os in
                "Legion")
                    module load rsd-modules
                    module load hemelb-dev/$compiler
                    export CC=mpicc
                    export CXX=mpiCC
                ;;
                "OSX")
                    case $compiler in 
                        "gnu")
                            export CC=gcc-4.9
                            export CXX=g++-4.9
                            inc=/Applications/Xcode.app/Contents/Developer//Toolchains/XcodeDefault.xctoolchain
                            inc=$(dirname $(find $inc -name type_traits))
                            cdir=$(dirname $(find /usr/local/lib/gcc -name libgcc_s.1.dylib))
                            export CXXFLAGS="-nodefaultlibs -nostdinc++ -isystem$inc -std=c++11"
                            export LDFLAGS="-L$cdir -lc++ -lc -std=c++11"
                        ;;
                        "clang")
                            export CC=/usr/bin/cc
                            export CXX=/usr/bin/c++
                            $CXX --version
                        ;;
                    esac
                ;;
            esac

            builddir=$WORKSPACE/build/{build_dir}
            [[ -e $builddir ]] || mkdir -p $builddir
            cd $builddir
            cmake -DCMAKE_BUILD_TYPE={build_type} \
                  -DCMAKE_INSTALL_PREFIX=$WORKSPACE/build/fake_install \
                  {extra_args} \
                  {source_dir}

- builder:
    name: heme-build
    builders:
        - shell: |
            builddir=$WORKSPACE/build/{build_dir}
            [[ -e $builddir ]] || mkdir -p $builddir
            cd $builddir

            if [ "$os" == "Legion" ] ; then
                export MAKEFLAGS=-j4
                module load rsd-modules hemelb-dev/$compiler
            else
                export MAKEFLAGS=-j2
            fi
            make

- builder:
    name: heme-test
    builders:
        - shell: |
            cd $WORKSPACE/build/{unittests_dir}
            [[ "$os" == "Legion" ]] && module load rsd-modules hemelb-dev/$compiler
            [[ ! -e $WORKSPACE/build/tests ]] && mkdir $WORKSPACE/build/tests
            mpirun -n 1 ./unittests_hemelb -o $WORKSPACE/build/tests/results.xml
